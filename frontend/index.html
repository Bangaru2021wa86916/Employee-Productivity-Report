<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Edit Employee</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Admin Login</h2>
  <div id="login-section">
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>

  <div id="employee-section" style="display:none;">
    <h2>Employee Management</h2>
    <table border="1">
      <thead>
        <tr>
          <th>ID</th><th>Name</th><th>Role</th><th>Feedback</th><th>Rating</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="employee-table"></tbody>
    </table>
  </div>
<script>
  let token = '';

async function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();

  try {
    const res = await fetch("http://backend:5000/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });

    if (!res.ok) {
      const err = await res.json();
      alert(err.msg || "Login failed!");
      return;
    }

    const data = await res.json();
    token = data.token;

    document.getElementById("login-section").style.display = "none";
    document.getElementById("employee-section").style.display = "block";

    await loadEmployees();
  } catch (err) {
    console.error("Login error:", err);
    alert("Unable to reach the server. Make sure Flask is running.");
  }
}

async function loadEmployees() {
  try {
    const res = await fetch("http://backend:5000/employees", {
      headers: { "Authorization": "Bearer " + token }
    });

    if (!res.ok) {
      alert("Token expired or invalid. Please log in again.");
      location.reload();
      return;
    }

    const data = await res.json();
    const table = document.getElementById("employee-table");
    table.innerHTML = '';

    data.forEach(emp => {
      table.innerHTML += `
        <tr>
          <td>${emp.id}</td>
          <td><input value="${emp.name}" id="name-${emp.id}"></td>
          <td><input value="${emp.role}" id="role-${emp.id}"></td>
          <td><input value="${emp.feedback}" id="feedback-${emp.id}"></td>
          <td><input value="${emp.rating}" id="rating-${emp.id}" type="number" step="0.1"></td>
          <td><button onclick="updateEmployee(${emp.id})">Save</button></td>
        </tr>`;
    });
  } catch (err) {
    console.error("Load error:", err);
    alert("Could not fetch employee data.");
  }
}

async function updateEmployee(id) {
  const name = document.getElementById(`name-${id}`).value;
  const role = document.getElementById(`role-${id}`).value;
  const feedback = document.getElementById(`feedback-${id}`).value;
  const rating = parseFloat(document.getElementById(`rating-${id}`).value);

  try {
    const res = await fetch(`http://backend:5000/employee/${id}`, {
      method: "PUT",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ name, role, feedback, rating })
    });

    const data = await res.json();

    if (res.ok) {
      alert("✅ Employee updated successfully!");
      await loadEmployees();
    } else {
      alert("❌ " + (data.msg || "Failed to update employee"));
    }
  } catch (err) {
    console.error("Update error:", err);
    alert("Server error while updating employee.");
  }
}
</script>
</body>
</html>
